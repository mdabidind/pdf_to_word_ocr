<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDF â†’ Word Converter</title>
<style>
  body{font-family:Arial;display:flex;align-items:center;justify-content:center;height:100vh;background:#f3f6ff}
  .card{width:820px;background:white;padding:22px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
  .drop{border:3px dashed rgba(99,102,241,.16);padding:30px;border-radius:10px;text-align:center;cursor:pointer}
  .muted{color:#6b7280;font-size:13px}
  .progress{height:12px;background:#eef2ff;border-radius:999px;margin-top:12px;overflow:hidden;display:none}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#6366f1,#4f46e5);transition:width .2s}
  .actions{margin-top:14px}
  .btn{padding:8px 14px;border-radius:8px;border:none;background:#4f46e5;color:#fff;cursor:pointer}
  #downloadBtn{display:none}
</style>
</head>
<body>
  <div class="card">
    <h2>PDF â†’ Word Converter</h2>

    <div id="dropZone" class="drop">
      <p class="muted">Drag & drop PDF here or <button id="browseBtn" class="btn" type="button">Browse</button></p>
      <input id="fileElem" type="file" accept="application/pdf" style="display:none" />
      <div id="filename" class="muted"></div>
    </div>

    <div class="progress" id="uploadProgress"><div class="bar" id="uploadBar"></div></div>
    <div id="status" style="margin-top:10px;color:#333"></div>

    <div class="actions">
      <button id="downloadBtn" class="btn">Download Converted .docx</button>
      <button id="convertAgainBtn" class="btn" style="display:none;background:#ddd;color:#111">Convert Again</button>
    </div>
  </div>

<script>
/* ============================================
   ðŸ”§ Backend auto-detection logic
   ============================================ */
let SERVER_URL = "";

// 1) If running on localhost â†’ use local Flask server
if (location.hostname === "127.0.0.1" || location.hostname === "localhost") {
  SERVER_URL = "http://127.0.0.1:5000";
}
// 2) If running on GitHub Pages or other domain â†’ use same origin (assume backend deployed under same domain)
else {
  SERVER_URL = location.origin;  
  // ðŸ‘‰ If backend is on different server, hardcode here:
  // SERVER_URL = "https://your-backend-domain.com";
}

console.log("Using backend:", SERVER_URL);

/* ============================================
   UI + Upload Logic
   ============================================ */
const dropZone = document.getElementById('dropZone');
const fileElem = document.getElementById('fileElem');
const browseBtn = document.getElementById('browseBtn');
const filenameEl = document.getElementById('filename');
const uploadProgress = document.getElementById('uploadProgress');
const uploadBar = document.getElementById('uploadBar');
const statusEl = document.getElementById('status');
const downloadBtn = document.getElementById('downloadBtn');
const convertAgainBtn = document.getElementById('convertAgainBtn');

browseBtn.addEventListener('click', ()=> fileElem.click());

dropZone.addEventListener('dragover', e=>{ e.preventDefault(); dropZone.style.opacity=0.9; });
dropZone.addEventListener('dragleave', e=>{ dropZone.style.opacity=1; });
dropZone.addEventListener('drop', e=>{ e.preventDefault(); dropZone.style.opacity=1; if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });

fileElem.addEventListener('change', e=>{ if(e.target.files.length) handleFile(e.target.files[0]); });

function resetUI(){
  uploadProgress.style.display='none';
  uploadBar.style.width='0%';
  statusEl.textContent='';
  downloadBtn.style.display='none';
  convertAgainBtn.style.display='none';
  filenameEl.textContent='';
}

function handleFile(file){
  resetUI();
  if(!file || file.type !== 'application/pdf'){ alert('Please select a PDF file'); return; }
  filenameEl.textContent = 'Selected: ' + file.name;

  const form = new FormData();
  form.append('file', file);

  const xhr = new XMLHttpRequest();
  xhr.open('POST', SERVER_URL + '/upload', true);

  xhr.upload.onprogress = function(e){
    if(e.lengthComputable){
      uploadProgress.style.display = 'block';
      const pct = Math.round((e.loaded/e.total)*100);
      uploadBar.style.width = pct + '%';
      statusEl.textContent = 'Uploading: ' + pct + '%';
    }
  };

  xhr.onload = function(){
    if(xhr.status === 200){
      let resp;
      try{ resp = JSON.parse(xhr.responseText); } catch(err){
        statusEl.textContent = 'Unexpected server response: ' + xhr.responseText; return;
      }
      statusEl.textContent = 'Upload successful â€” conversion started...';
      pollStatus(resp.id);
    } else {
      statusEl.textContent = 'Upload failed: ' + xhr.status + ' â€” ' + xhr.responseText;
    }
  };

  xhr.onerror = function(){ statusEl.textContent = 'Upload error (network/server)'; }
  xhr.send(form);
}

let pollTimer = null;
function pollStatus(id){
  pollTimer = setInterval(async ()=>{
    try{
      const r = await fetch(SERVER_URL + '/status?id=' + encodeURIComponent(id));
      if(r.status!==200){ statusEl.textContent = 'Status request failed'; return; }
      const j = await r.json();
      statusEl.textContent = 'Conversion â€” ' + j.status + (j.progress?(' : ' + j.progress + '%'):'');
      if(j.status === 'done'){
        clearInterval(pollTimer);
        downloadBtn.style.display='inline-block';
        downloadBtn.onclick = ()=> { window.location = SERVER_URL + '/download?file=' + encodeURIComponent(j.out); };
        convertAgainBtn.style.display='inline-block';
        convertAgainBtn.onclick = ()=> resetUI();
      }
      if(j.status === 'error'){
        clearInterval(pollTimer);
        statusEl.textContent = 'Conversion failed: ' + (j.message||'unknown');
      }
    }catch(err){ console.error(err); statusEl.textContent='Network error while polling'; }
  }, 1500);
}
</script>
</body>
</html>
